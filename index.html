<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parquet Viewer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>">
    <style>
        :root {
            /* VSCode Dark Theme Colors */
            --vscode-bg: #1e1e1e;
            --vscode-sidebar-bg: #252526;
            --vscode-editor-bg: #1f1f1f;
            --vscode-panel-bg: #2d2d30;
            --vscode-border: #3e3e42;
            --vscode-text: #cccccc;
            --vscode-text-muted: #969696;
            --vscode-text-active: #ffffff;
            --vscode-accent: #007acc;
            --vscode-accent-hover: #1177bb;
            --vscode-success: #4ec9b0;
            --vscode-warning: #dcdcaa;
            --vscode-error: #f14c4c;
            --vscode-modified: #e2c08d;
            --vscode-added: #73c991;
            --vscode-selection: #264f78;
            --vscode-hover: #2a2d2e;
            --vscode-focus: #007fd4;
            --vscode-button: #0e639c;
            --vscode-button-hover: #1177bb;
            --vscode-input-bg: #3c3c3c;
            --vscode-dropdown: #3c3c3c;
            
            /* Light theme will be added as .light-theme class */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .light-theme {
            /* VSCode Light Theme Colors */
            --vscode-bg: #ffffff;
            --vscode-sidebar-bg: #f8f8f8;
            --vscode-editor-bg: #ffffff;
            --vscode-panel-bg: #f3f3f3;
            --vscode-border: #d0d0d0;
            --vscode-text: #1e1e1e;
            --vscode-text-muted: #616161;
            --vscode-text-active: #000000;
            --vscode-accent: #0078d4;
            --vscode-accent-hover: #106ebe;
            --vscode-success: #16825d;
            --vscode-warning: #bf8803;
            --vscode-error: #a1260d;
            --vscode-modified: #bf8803;
            --vscode-hover: #e8e8e8;
            --vscode-added: #16825d;
            --vscode-selection: #add6ff;
            --vscode-hover: #e8e8e8;
            --vscode-focus: #005fb8;
            --vscode-button: #0078d4;
            --vscode-button-hover: #106ebe;
            --vscode-input-bg: #ffffff;
            --vscode-dropdown: #ffffff;
            
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        /* Light theme specific overrides */
        .light-theme .loading-spinner {
            border: 4px solid var(--vscode-border);
            border-top: 4px solid var(--vscode-accent);
        }

        .light-theme .progress-fill {
            background: var(--vscode-border);
        }

        .light-theme .section-badge.secondary {
            background: var(--vscode-border);
            color: var(--vscode-text-muted);
        }

        .light-theme .filter-option:hover {
            background: var(--vscode-hover);
        }

        .light-theme .tab-container {
            background: var(--vscode-panel-bg);
        }

        .light-theme .tab:hover:not(.active) {
            background: var(--vscode-hover);
            color: var(--vscode-text);
        }

        .light-theme .info-card {
            background: var(--vscode-panel-bg);
            border: 1px solid var(--vscode-border);
        }

        .light-theme .info-card:hover {
            background: var(--vscode-hover);
        }

        .light-theme .stat-card {
            background: var(--vscode-panel-bg);
            border: 1px solid var(--vscode-border);
        }

        .light-theme table {
            background: var(--vscode-editor-bg);
        }

        .light-theme th {
            background: var(--vscode-panel-bg);
            border-bottom: 1px solid var(--vscode-border);
        }

        .light-theme th.sortable:hover {
            background: var(--vscode-hover);
        }

        .light-theme td {
            border-bottom: 1px solid var(--vscode-border);
        }

        .light-theme tr:hover {
            background: var(--vscode-hover);
        }

        .light-theme .row-number {
            background: var(--vscode-panel-bg) !important;
        }

        .light-theme .cell-editable:hover {
            background: var(--vscode-selection) !important;
            box-shadow: inset 0 0 0 1px var(--vscode-accent);
        }

        .light-theme .table-container {
            border: 1px solid var(--vscode-border);
        }

        .light-theme .pagination {
            border-top: 1px solid var(--vscode-border);
        }

        .light-theme .page-btn {
            background: var(--vscode-editor-bg);
            border: 1px solid var(--vscode-border);
            color: var(--vscode-text);
        }

        .light-theme .page-btn:hover:not(:disabled) {
            background: var(--vscode-hover);
        }

        .light-theme .page-btn:disabled {
            background: var(--vscode-panel-bg);
            color: var(--vscode-text-muted);
        }

        .light-theme .export-btn {
            background: var(--vscode-editor-bg);
            border: 2px solid var(--vscode-accent);
            color: var(--vscode-text);
        }

        .light-theme .export-btn:hover {
            background: var(--vscode-hover);
        }

        .light-theme .metadata-content {
            border: 1px solid var(--vscode-border);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', 'Source Code Pro', monospace;
            background: var(--vscode-bg);
            min-height: 100vh;
            color: var(--vscode-text);
            padding: 10px;
            line-height: 1.4;
            overflow-x: hidden;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 6px;
            font-weight: 700;
            color: var(--vscode-text-active);
            font-family: inherit;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 6px;
        }
        
        .privacy-badge {
            display: inline-flex;
            gap: 12px;
            margin-top: 6px;
            font-size: 0.75rem;
            opacity: 0.8;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge {
            background: var(--vscode-panel-bg);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--vscode-border);
            color: var(--vscode-text-muted);
            font-size: 0.75rem;
        }
        
        .upload-area {
            background: var(--vscode-editor-bg);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            border: 2px dashed var(--vscode-border);
            transition: all 0.3s ease;
            margin-bottom: 30px;
            position: relative;
        }
        
        .upload-area:hover {
            background: var(--vscode-hover);
            border-color: var(--vscode-accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .upload-area.dragover {
            background: var(--vscode-selection);
            border-color: var(--vscode-accent);
            transform: scale(1.02);
            box-shadow: 0 0 20px var(--vscode-accent);
        }
        
        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: var(--vscode-button);
            border: 1px solid var(--vscode-button);
            color: var(--vscode-text-active);
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn:hover {
            background: var(--vscode-button-hover);
            border-color: var(--vscode-button-hover);
        }

        .btn-secondary {
            background: var(--vscode-panel-bg);
            border-color: var(--vscode-border);
            color: var(--vscode-text);
        }

        .btn-secondary:hover {
            background: var(--vscode-hover);
            border-color: var(--vscode-accent);
        }

        .btn-small {
            padding: 6px 16px;
            font-size: 0.9rem;
            border-radius: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-light);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid white;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.5);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .error h3 {
            margin-bottom: 10px;
            color: #fca5a5;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid rgba(16, 185, 129, 0.5);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .results-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 12px;
            height: calc(100vh - 40px);
            overflow: hidden;
            flex: 1;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .compact-section {
            background: var(--vscode-sidebar-bg);
            border-radius: 4px;
            padding: 8px;
            border: 1px solid var(--vscode-border);
            box-shadow: var(--shadow-sm);
        }

        .compact-section h3 {
            font-size: 0.85rem;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: var(--vscode-text-active);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-preview-section {
            background: var(--vscode-editor-bg);
            border: 1px solid var(--vscode-border);
            box-shadow: var(--shadow-md);
            border-radius: 6px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
        }

        .data-preview-section h2 {
            font-size: 1.2rem;
            color: var(--vscode-text-active);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-family: inherit;
        }

        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 6px;
            margin-bottom: 8px;
        }

        .compact-card {
            background: var(--vscode-panel-bg);
            padding: 6px;
            border-radius: 3px;
            border: 1px solid var(--vscode-border);
            text-align: center;
        }

        .compact-card .label {
            font-size: 0.65rem;
            color: var(--vscode-text-muted);
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 500;
        }

        .compact-card .value {
            font-size: 0.8rem;
            font-weight: 600;
            word-break: break-all;
            color: var(--vscode-text);
        }

        .mini-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 6px;
            background: var(--vscode-panel-bg);
            padding: 2px;
            border-radius: 4px;
        }

        .mini-tab {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: var(--vscode-text-muted);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            flex: 1;
            text-align: center;
            font-family: inherit;
        }

        .mini-tab.active {
            background: var(--vscode-accent);
            color: var(--vscode-text-active);
            font-weight: 600;
        }

        .section-badge {
            background: var(--accent-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-badge.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-muted);
        }

        .section-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            background: var(--vscode-editor-bg);
            border: 1px solid var(--vscode-border);
            border-radius: 25px;
            color: var(--vscode-text);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: var(--vscode-text-muted);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--vscode-accent);
            background: var(--vscode-editor-bg);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        .filter-dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--vscode-panel-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--vscode-border);
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;
            min-width: 200px;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .dropdown-content.show {
            display: block;
        }

        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 10px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .info-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 700;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        th.sortable:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        th.sorted-asc::after {
            content: ' â†‘';
            opacity: 0.7;
        }

        th.sorted-desc::after {
            content: ' â†“';
            opacity: 0.7;
        }
        
        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
            font-size: 0.85rem;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .row-number {
            background: rgba(255, 255, 255, 0.1) !important;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.8;
            width: 60px;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .cell-null {
            color: #9ca3af;
            font-style: italic;
            opacity: 0.7;
        }

        .cell-boolean {
            color: #fbbf24;
            font-weight: 600;
        }

        .cell-number {
            color: #34d399;
            font-weight: 500;
            text-align: right;
        }

        .cell-string {
            color: #e5e7eb;
        }

        .cell-object {
            color: #a78bfa;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .cell-editable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell-editable:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3);
        }

        .cell-editing {
            background: rgba(99, 102, 241, 0.2) !important;
            box-shadow: inset 0 0 0 2px var(--accent-color);
        }

        .cell-edit-input {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            width: 100%;
            padding: 0;
            outline: none;
        }

        .cell-modified {
            background: rgba(16, 185, 129, 0.1) !important;
            border-left: 3px solid var(--success-color);
        }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-string { background: #1e40af; color: white; }
        .type-number { background: #059669; color: white; }
        .type-boolean { background: #d97706; color: white; }
        .type-date { background: #7c3aed; color: white; }
        .type-object { background: #dc2626; color: white; }

        .encoding-badge {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            background: rgba(99, 102, 241, 0.2);
            color: #c7d2fe;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .compression-badge {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .table-wrapper {
            overflow: auto;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            min-height: 0;
        }

        .data-preview-table {
            height: 100%;
        }

        .metadata-section .table-wrapper {
            max-height: 120px;
            font-size: 0.7rem;
        }

        .compact-section .table-wrapper table {
            font-size: 0.7rem;
        }

        .compact-section .table-wrapper th,
        .compact-section .table-wrapper td {
            padding: 4px 6px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 150px;
            max-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 32px 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            color: white;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .page-info {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .page-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .export-btn {
            background: var(--bg-glass);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .metadata-raw {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .hidden {
            display: none !important;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .performance-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .mode-toggle {
            display: flex;
            gap: 2px;
            background: var(--vscode-panel-bg);
            border-radius: 4px;
            padding: 2px;
            border: 1px solid var(--vscode-border);
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: var(--vscode-text-muted);
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            font-weight: 500;
        }

        .mode-btn:hover {
            background: var(--vscode-hover);
            color: var(--vscode-text);
        }

        .mode-btn.active {
            background: var(--vscode-accent);
            color: var(--vscode-text-active);
            pointer-events: none;
            cursor: default;
        }

        .help-icon {
            background: transparent;
            border: none;
            color: var(--vscode-text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-icon:hover {
            background: var(--vscode-hover);
            color: var(--vscode-text);
        }

        .tree-view {
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .tree-node {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 2px 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 2px;
        }

        .tree-item:hover {
            background: var(--vscode-hover);
        }

        .tree-toggle {
            width: 12px;
            height: 12px;
            margin-right: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--vscode-text-muted);
            user-select: none;
        }

        .tree-toggle.expandable::before {
            content: 'â–¶';
            transition: transform 0.2s ease;
        }

        .tree-toggle.expanded::before {
            transform: rotate(90deg);
        }

        .tree-label {
            color: var(--vscode-text);
            font-weight: 500;
            margin-right: 6px;
        }

        .tree-value {
            color: var(--vscode-text-muted);
            font-weight: 400;
            margin-left: auto;
        }

        .tree-children {
            margin-left: 16px;
            border-left: 1px solid var(--vscode-border);
            padding-left: 8px;
            margin-top: 2px;
        }

        .tree-children.collapsed {
            display: none;
        }

        .tree-type-badge {
            font-size: 0.65rem;
            padding: 1px 4px;
            border-radius: 2px;
            margin-left: 4px;
        }

        .credits {
            margin-top: 20px;
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .credits:hover {
            opacity: 0.8;
        }

        .credits-link {
            color: var(--vscode-text-muted);
            text-decoration: none;
            font-family: inherit;
            font-weight: 400;
            transition: color 0.3s ease;
        }

        .credits-link:hover {
            color: var(--vscode-text);
            text-decoration: underline;
        }

        .sidebar-credits {
            margin-top: auto;
            padding: 8px 0;
            text-align: center;
            font-size: 0.65rem;
            opacity: 0.4;
            transition: opacity 0.3s ease;
            border-top: 1px solid var(--vscode-border);
        }

        .sidebar-credits:hover {
            opacity: 0.7;
        }

        .sidebar-credits-link {
            color: var(--vscode-text-muted);
            text-decoration: none;
            font-family: inherit;
            font-weight: 400;
            transition: color 0.3s ease;
        }

        .sidebar-credits-link:hover {
            color: var(--vscode-text);
            text-decoration: underline;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(16, 185, 129, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.95);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .toast.info {
            background: rgba(59, 130, 246, 0.95);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .upload-icon {
                width: 60px;
                height: 60px;
            }
            
            .upload-text {
                font-size: 1.2rem;
            }
            
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px 6px;
            }

            .section {
                padding: 20px 15px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .pagination {
                flex-direction: column;
                gap: 10px;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .privacy-badge {
                flex-direction: column;
                gap: 10px;
            }

            .page-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }

            .export-buttons {
                flex-direction: column;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div></div>
                <div style="text-align: center; flex: 1;">
                    <h1>âš¡ Parquet Viewer</h1>
                    <div class="subtitle">Analyze Parquet files instantly in your browser</div>
                </div>
                <button id="themeToggle" class="btn btn-small" onclick="toggleTheme()" title="Toggle light/dark theme">
                    <svg id="themeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
            <div class="privacy-badge">
                <span class="badge">ðŸ”’ 100% Private</span>
                <span class="badge">ðŸ“Š No Upload Required</span>
                <span class="badge">âš¡ Lightning Fast</span>
            </div>
        </header>

        <div id="uploadSection" class="upload-area">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <div class="upload-text">Drop Parquet File Here</div>
            <div class="upload-subtext">Supports .parquet files up to 500MB</div>
            <input type="file" id="fileInput" class="file-input" accept=".parquet">
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                </svg>
                Select File
            </button>
            
            <div class="credits">
                <a href="https://github.com/mjtpena/parquet-viewer" target="_blank" rel="noopener" class="credits-link">
                    mjtpena/parquet-viewer
                </a>
            </div>
        </div>

        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <div id="loadingText">Processing Parquet file...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="loadingStats" style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;"></div>
        </div>

        <div id="errorSection" class="error hidden">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Error Loading File
            </h3>
            <div id="errorMessage"></div>
            <button class="btn btn-small" style="margin-top: 15px;" onclick="resetViewer()">Try Another File</button>
        </div>

        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>

        <div id="resultsSection" class="hidden">
            <div class="results-layout">
                <!-- Sidebar with compact info -->
                <div class="sidebar">
                    <!-- File Actions -->
                    <div class="compact-section">
                        <h3>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path d="M8 21v-4a2 2 0 012-2h4a2 2 0 012 2v4"></path>
                            </svg>
                            Actions
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button class="btn btn-secondary btn-small" onclick="uploadNewFile()" style="width: 100%; justify-content: center; font-size: 0.75rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                Upload New
                            </button>
                            <button class="btn btn-small" onclick="downloadCurrentFile()" style="width: 100%; justify-content: center; font-size: 0.75rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download
                            </button>
                        </div>
                    </div>

                    <!-- File Overview -->
                    <div class="compact-section">
                        <h3>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                            </svg>
                            File Overview
                        </h3>
                        <div id="fileInfo" class="compact-grid"></div>
                        <div id="fileStats" class="compact-grid" style="margin-top: 10px;"></div>
                    </div>

                    <!-- Metadata Tabs -->
                    <div class="compact-section">
                        <h3>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path>
                            </svg>
                            Metadata
                        </h3>
                        <div class="mini-tabs">
                            <button class="mini-tab active" onclick="showMetaTab('general')">General</button>
                            <button class="mini-tab" onclick="showMetaTab('schema')">Schema</button>
                            <button class="mini-tab" onclick="showMetaTab('columns')">Stats</button>
                        </div>
                        
                        <div id="metaGeneral" class="tab-content active">
                            <div id="generalMetadata" class="compact-grid"></div>
                        </div>
                        
                        <div id="metaSchema" class="tab-content">
                            <div class="tree-view" id="schemaTree"></div>
                        </div>
                        
                        <div id="metaColumns" class="tab-content">
                            <div class="tree-view" id="columnStatsTree"></div>
                        </div>
                    </div>

                    <!-- File Actions -->
                    <div class="compact-section">
                        <h3>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button class="page-btn" onclick="downloadModified()" style="justify-content: center; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; padding: 4px 8px; display: none;" id="saveParquetBtn">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download Modified
                            </button>
                            <button class="page-btn" onclick="downloadCopy()" style="justify-content: center; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download Copy
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="compact-section">
                        <h3>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Convert & Export
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button class="page-btn" onclick="exportData('csv')" style="justify-content: center; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                                    <path d="M14 2v6h6"></path>
                                    <path d="M16 13H8"></path>
                                    <path d="M16 17H8"></path>
                                    <path d="M10 9H8"></path>
                                </svg>
                                Export CSV
                            </button>
                            <button class="page-btn" onclick="exportData('json')" style="justify-content: center; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                                    <path d="M14 2v6h6"></path>
                                    <path d="M12 18v-6"></path>
                                    <path d="M9 15l3-3 3 3"></path>
                                </svg>
                                Export JSON
                            </button>
                        </div>
                    </div>

                    <!-- Subtle credits -->
                    <div class="sidebar-credits">
                        <a href="https://github.com/mjtpena/parquet-viewer" target="_blank" rel="noopener" class="sidebar-credits-link">
                            github.com/mjtpena/parquet-viewer
                        </a>
                    </div>
                </div>

                <!-- Main Content - Data Preview -->
                <div class="main-content">
                    <div class="data-preview-section">
                        <h2>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v18H3zM21 9H3M9 21V9"></path>
                            </svg>
                            Data Preview
                            <div style="display: flex; align-items: center; gap: 12px; margin-left: auto;">
                                <div class="mode-toggle">
                                    <button id="viewModeBtn" class="mode-btn active" onclick="setMode('view')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        View
                                    </button>
                                    <button id="editModeBtn" class="mode-btn" onclick="setMode('edit')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                </div>
                                <button id="resultsThemeToggle" class="btn btn-small" onclick="toggleTheme()" title="Toggle light/dark theme">
                                    <svg id="resultsThemeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="5"></circle>
                                        <line x1="12" y1="1" x2="12" y2="3"></line>
                                        <line x1="12" y1="21" x2="12" y2="23"></line>
                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                        <line x1="1" y1="12" x2="3" y2="12"></line>
                                        <line x1="21" y1="12" x2="23" y2="12"></line>
                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                    </svg>
                                </button>
                            </div>
                        </h2>
                        
                        <div class="table-controls">
                            <div class="search-box">
                                <input type="text" id="searchInput" class="search-input" placeholder="Search data...">
                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35"></path>
                                </svg>
                            </div>
                            
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="pageSizeSelect" onchange="changePageSize()" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 6px 10px; font-size: 0.8rem;">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                                
                                <button class="help-icon" onclick="showModeHelp()" title="View/Edit mode information">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </button>
                                
                                <button class="help-icon" onclick="showKeyboardHelp()" title="Keyboard shortcuts: ? help â€¢ Ctrl+F search â€¢ â†â†’ navigate â€¢ Ctrl+E export â€¢ Esc reset">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                                        <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M9 16h6"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-wrapper data-preview-table">
                            <table id="dataTable"></table>
                        </div>
                        
                        <div class="pagination">
                            <div class="page-info" id="pageInfo"></div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button id="firstBtn" class="page-btn" onclick="goToPage(0)">First</button>
                                <button id="prevBtn" class="page-btn" onclick="changePage(-1)">Prev</button>
                                <input type="number" id="pageJumpInput" min="1" onkeypress="handlePageJump(event)" style="width: 50px; padding: 4px 6px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: white; text-align: center; font-size: 0.8rem;">
                                <span id="totalPagesText" style="font-size: 0.8rem; opacity: 0.8;"></span>
                                <button id="nextBtn" class="page-btn" onclick="changePage(1)">Next</button>
                                <button id="lastBtn" class="page-btn" onclick="goToLastPage()">Last</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { parquetMetadata, parquetRead, parquetSchema } from 'https://cdn.jsdelivr.net/npm/hyparquet@1.16.0/+esm';
        import { tableFromJSON, tableToIPC } from 'https://cdn.jsdelivr.net/npm/apache-arrow@17.0.0/+esm';
        import initWasm, { writeParquet, Table, WriterPropertiesBuilder, Compression } from 'https://cdn.jsdelivr.net/npm/parquet-wasm@0.6.1/+esm';
        
        // Global state
        let state = {
            data: [],
            filteredData: [],
            metadata: null,
            schema: null,
            currentPage: 0,
            pageSize: 50,
            searchTerm: '',
            sortColumn: null,
            sortDirection: 'asc',
            processingStartTime: null,
            selectedFile: null,
            modifiedCells: new Set(),
            isEditing: false,
            currentMode: 'view'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            setupEventListeners();
            setupKeyboardShortcuts();
            initializeTheme();
        }

        function initializeTheme() {
            // Check for saved theme preference or default to dark
            const savedTheme = localStorage.getItem('parquet-viewer-theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                updateThemeIcon(true);
            }
        }

        window.toggleTheme = function() {
            const isLight = document.body.classList.toggle('light-theme');
            localStorage.setItem('parquet-viewer-theme', isLight ? 'light' : 'dark');
            updateThemeIcon(isLight);
        }

        function updateThemeIcon(isLight) {
            const themeIcon = document.getElementById('themeIcon');
            const resultsThemeIcon = document.getElementById('resultsThemeIcon');
            
            const iconHTML = isLight 
                ? `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>` // Moon icon for light theme
                : `<circle cx="12" cy="12" r="5"></circle>
                   <line x1="12" y1="1" x2="12" y2="3"></line>
                   <line x1="12" y1="21" x2="12" y2="23"></line>
                   <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                   <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                   <line x1="1" y1="12" x2="3" y2="12"></line>
                   <line x1="21" y1="12" x2="23" y2="12"></line>
                   <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                   <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`; // Sun icon for dark theme
            
            if (themeIcon) themeIcon.innerHTML = iconHTML;
            if (resultsThemeIcon) resultsThemeIcon.innerHTML = iconHTML;
        }

        window.setMode = function(mode) {
            if (state.currentMode === mode) return; // Don't do anything if already in this mode
            
            state.currentMode = mode;
            
            // Update button states
            document.getElementById('viewModeBtn').classList.toggle('active', mode === 'view');
            document.getElementById('editModeBtn').classList.toggle('active', mode === 'edit');
            
            // Refresh data display to apply mode changes
            displayData();
        }

        window.showModeHelp = function() {
            const helpText = state.currentMode === 'edit' 
                ? 'Edit Mode: Click any data cell to modify values. Changes are local-only for exploration.'
                : 'View Mode: Browse data in read-only format. Switch to Edit mode to modify values.';
            
            showToast(helpText, 'info', 4000);
        }

        window.showKeyboardHelp = function() {
            const helpText = 'Keyboard Shortcuts:\nâ€¢ ? - Show this help\nâ€¢ Ctrl+F - Focus search\nâ€¢ â†â†’ - Navigate pages\nâ€¢ Ctrl+S - Download Modified\nâ€¢ Ctrl+E - Export CSV\nâ€¢ Esc - Reset view';
            showToast(helpText.replace(/\n/g, '<br>'), 'info', 6000);
        }

        // Tree view utilities
        function createTreeNode(data, level = 0) {
            const li = document.createElement('li');
            li.className = 'tree-node';
            
            const item = document.createElement('div');
            item.className = 'tree-item';
            
            const toggle = document.createElement('span');
            toggle.className = 'tree-toggle';
            
            const label = document.createElement('span');
            label.className = 'tree-label';
            label.textContent = data.label;
            
            const value = document.createElement('span');
            value.className = 'tree-value';
            
            if (data.value !== undefined) {
                value.textContent = data.value;
            }
            
            if (data.badge) {
                const badge = document.createElement('span');
                badge.className = `tree-type-badge type-${data.badge.toLowerCase()}`;
                badge.textContent = data.badge;
                value.appendChild(badge);
            }
            
            item.appendChild(toggle);
            item.appendChild(label);
            item.appendChild(value);
            li.appendChild(item);
            
            if (data.children && data.children.length > 0) {
                toggle.classList.add('expandable');
                
                const children = document.createElement('ul');
                children.className = 'tree-children collapsed';
                
                data.children.forEach(child => {
                    children.appendChild(createTreeNode(child, level + 1));
                });
                
                li.appendChild(children);
                
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggle.classList.toggle('expanded');
                    children.classList.toggle('collapsed');
                });
            }
            
            return li;
        }

        function createTreeView(container, data) {
            const ul = document.createElement('ul');
            ul.className = 'tree-view';
            
            data.forEach(item => {
                ul.appendChild(createTreeNode(item));
            });
            
            container.innerHTML = '';
            container.appendChild(ul);
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');
            const searchInput = document.getElementById('searchInput');

            // Drag and drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // File input
            fileInput.addEventListener('change', handleFileSelect);
            
            // Search
            searchInput.addEventListener('input', debounce(handleSearch, 300));
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', async (e) => {
                // Ctrl+F - Focus search
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput')?.focus();
                }
                // Arrow keys for pagination
                else if (e.key === 'ArrowLeft' && !e.target.matches('input')) {
                    changePage(-1);
                }
                else if (e.key === 'ArrowRight' && !e.target.matches('input')) {
                    changePage(1);
                }
                // Ctrl+S - Download Modified
                else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (state.modifiedCells.size > 0) {
                        try {
                            await downloadModified();
                        } catch (error) {
                            // Error handling is already done in downloadModified
                        }
                    } else {
                        showToast('No modifications to download', 'info');
                    }
                }
                // Ctrl+E - Export CSV
                else if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportData('csv');
                }
                // Escape - Reset view
                else if (e.key === 'Escape') {
                    resetViewer();
                }
                // ? - Show keyboard help
                else if (e.key === '?') {
                    showKeyboardHelp();
                }
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        }

        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.parquet')) {
                showError('Please select a valid .parquet file');
                return;
            }

            if (file.size > 500 * 1024 * 1024) { // 500MB limit
                showError('File size exceeds 500MB limit. Please select a smaller file.');
                return;
            }

            state.selectedFile = file;
            state.processingStartTime = performance.now();
            
            showLoading();
            updateProgress(10, 'Reading file...');

            try {
                const buffer = await file.arrayBuffer();
                updateProgress(30, 'Parsing metadata...');
                
                // Parse metadata
                state.metadata = parquetMetadata(buffer);
                state.schema = parquetSchema(state.metadata);
                updateProgress(50, 'Loading data...');
                
                // Read data with progress tracking
                await parquetRead({
                    file: buffer,
                    rowFormat: 'object',
                    onComplete: (data) => {
                        console.log('Data loaded:', data.length, 'rows');
                        state.data = data;
                        updateProgress(90, 'Finalizing...');
                    }
                });
                console.log('Final data check:', state.data.length, 'rows');
                updateProgress(100, 'Complete!');
                
                setTimeout(() => {
                    showResults();
                }, 500);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showError(error.message || 'Failed to read file. Please ensure it\'s a valid Parquet file.');
            }
        }

        function updateProgress(percent, message) {
            const progressFill = document.getElementById('progressFill');
            const loadingText = document.getElementById('loadingText');
            const loadingStats = document.getElementById('loadingStats');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (loadingText) loadingText.textContent = message;
            
            if (loadingStats && state.processingStartTime) {
                const elapsed = ((performance.now() - state.processingStartTime) / 1000).toFixed(1);
                loadingStats.textContent = `Processing time: ${elapsed}s`;
            }
        }

        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const iconSvg = {
                success: '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><polyline points="22,4 12,14.01 9,11.01"></polyline></svg>',
                error: '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                info: '<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
            };
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                ${iconSvg[type]}
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="removeToast('${toastId}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove
            if (duration > 0) {
                setTimeout(() => removeToast(toastId), duration);
            }
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }
        }

        window.removeToast = removeToast;

        function showLoading() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function showError(message) {
            // Show header again when there's an error
            document.querySelector('header').classList.remove('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            showToast(message, 'error');
        }

        function showResults() {
            const processingTime = ((performance.now() - state.processingStartTime) / 1000).toFixed(2);
            
            console.log('showResults called with data:', state.data.length, 'rows');
            
            // Hide header to save space and show results
            document.querySelector('header').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            showToast(`File processed successfully in ${processingTime}s`);
            
            // Initialize filtered data
            state.filteredData = [...state.data];
            state.currentPage = 0;
            
            console.log('Filtered data:', state.filteredData.length, 'rows');
            
            // Render all sections
            displayFileInfo();
            displayMetadata();
            displayData();
            
            // Initialize mode toggle buttons
            document.getElementById('viewModeBtn').classList.add('active');
            document.getElementById('editModeBtn').classList.remove('active');
            state.currentMode = 'view';
            
            // Show performance info
            displayPerformanceInfo(processingTime);
        }

        function displayFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const fileStats = document.getElementById('fileStats');
            const file = state.selectedFile;
            const rows = Number(state.metadata.num_rows);
            const cols = state.schema.children.length;
            
            // Basic file info
            fileInfo.innerHTML = `
                <div class="compact-card">
                    <div class="label">File Name</div>
                    <div class="value">${file.name}</div>
                </div>
                <div class="compact-card">
                    <div class="label">File Size</div>
                    <div class="value">${formatSize(file.size)}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Total Rows</div>
                    <div class="value">${rows.toLocaleString()}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Columns</div>
                    <div class="value">${cols}</div>
                </div>
            `;

            // Calculate statistics
            const stats = calculateDataStatistics();
            fileStats.innerHTML = `
                <div class="compact-card">
                    <div class="label">Null Values</div>
                    <div class="value">${stats.nullCount.toLocaleString()}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Numeric</div>
                    <div class="value">${stats.numericColumns}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Text</div>
                    <div class="value">${stats.stringColumns}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Unique</div>
                    <div class="value">${stats.uniqueValues.toLocaleString()}</div>
                </div>
            `;
        }

        function calculateDataStatistics() {
            if (state.data.length === 0) return { nullCount: 0, numericColumns: 0, stringColumns: 0, uniqueValues: 0 };
            
            const columns = Object.keys(state.data[0]);
            let nullCount = 0;
            let numericColumns = 0;
            let stringColumns = 0;
            let uniqueValues = new Set();
            
            columns.forEach(col => {
                let hasNumbers = false;
                let hasStrings = false;
                
                state.data.forEach(row => {
                    const value = row[col];
                    if (value === null || value === undefined) {
                        nullCount++;
                    } else {
                        uniqueValues.add(String(value));
                        if (typeof value === 'number') hasNumbers = true;
                        else if (typeof value === 'string') hasStrings = true;
                    }
                });
                
                if (hasNumbers && !hasStrings) numericColumns++;
                else if (hasStrings) stringColumns++;
            });
            
            return { nullCount, numericColumns, stringColumns, uniqueValues: uniqueValues.size };
        }

        function displayPerformanceInfo(processingTime) {
            const perfInfo = document.getElementById('performanceInfo');
            const rowsPerSecond = Math.round(state.data.length / parseFloat(processingTime));
            const memoryUsage = formatSize(state.selectedFile.size);
            
            perfInfo.innerHTML = `
                <strong>Performance Metrics:</strong> 
                Processed ${state.data.length.toLocaleString()} rows in ${processingTime}s 
                (~${rowsPerSecond.toLocaleString()} rows/sec, ${memoryUsage} memory usage)
            `;
            perfInfo.classList.remove('hidden');
        }

        function displayMetadata() {
            // General metadata
            const generalMeta = document.getElementById('generalMetadata');
            const version = state.metadata.version || 1;
            const createdBy = state.metadata.created_by || 'Unknown';
            const rowGroups = state.metadata.row_groups?.length || 0;
            const numRows = Number(state.metadata.num_rows);
            
            generalMeta.innerHTML = `
                <div class="compact-card">
                    <div class="label">Version</div>
                    <div class="value">${version}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Created By</div>
                    <div class="value" title="${createdBy}">${createdBy.length > 20 ? createdBy.substring(0, 20) + '...' : createdBy}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Row Groups</div>
                    <div class="value">${rowGroups}</div>
                </div>
                <div class="compact-card">
                    <div class="label">Metadata</div>
                    <div class="value">${state.metadata.key_value_metadata?.length || 0} entries</div>
                </div>
            `;

            // Schema table
            displaySchemaTable();
            
            // Column statistics
            displayColumnStats();
        }

        function displaySchemaTable() {
            const schemaContainer = document.getElementById('schemaTree');
            const schemaData = state.schema.children.map(col => {
                const type = col.element.type || 'UNKNOWN';
                const convertedType = col.element.converted_type || null;
                const repetitionType = col.element.repetition_type || 'REQUIRED';
                const nullable = repetitionType !== 'REQUIRED';
                
                const children = [];
                if (type) children.push({ label: 'Type', value: type, badge: type });
                if (convertedType) children.push({ label: 'Converted Type', value: convertedType });
                children.push({ label: 'Repetition', value: repetitionType });
                children.push({ label: 'Nullable', value: nullable ? 'Yes' : 'No' });
                
                return {
                    label: col.element.name,
                    value: type,
                    badge: type,
                    children: children
                };
            });
            
            createTreeView(schemaContainer, schemaData);
        }

        function displayColumnStats() {
            const columnStatsContainer = document.getElementById('columnStatsTree');
            
            if (state.metadata.row_groups && state.metadata.row_groups.length > 0) {
                const firstRowGroup = state.metadata.row_groups[0];
                const statsData = firstRowGroup.columns.map((col, idx) => {
                    const colSchema = state.schema.children[idx];
                    const encodings = col.encodings ? col.encodings.join(', ') : 'PLAIN';
                    const compression = col.compression || 'UNCOMPRESSED';
                    const totalUncompressed = col.total_uncompressed_size || 0;
                    const totalCompressed = col.total_compressed_size || 0;
                    const ratio = totalUncompressed > 0 ? (totalCompressed / totalUncompressed * 100).toFixed(1) + '%' : '-';
                    
                    const children = [
                        { label: 'Type', value: colSchema.element.type, badge: colSchema.element.type },
                        { label: 'Encodings', value: encodings },
                        { label: 'Compression', value: compression },
                        { label: 'Uncompressed', value: formatSize(totalUncompressed) },
                        { label: 'Compressed', value: formatSize(totalCompressed) },
                        { label: 'Ratio', value: ratio }
                    ];
                    
                    return {
                        label: colSchema.element.name,
                        value: `${compression} (${ratio})`,
                        children: children
                    };
                });
                
                createTreeView(columnStatsContainer, statsData);
            } else {
                columnStatsContainer.innerHTML = '<div style="color: var(--vscode-text-muted); font-size: 0.75rem; padding: 8px;">No column statistics available</div>';
            }
        }

        function displayRowGroups() {
            const rowGroupTable = document.getElementById('rowGroupTable');
            let html = '<thead><tr><th>Row Group</th><th>Rows</th><th>Columns</th><th>Total Size</th><th>Compressed Size</th><th>Compression Ratio</th></tr></thead><tbody>';
            
            if (state.metadata.row_groups) {
                state.metadata.row_groups.forEach((rg, idx) => {
                    const totalUncompressed = rg.total_byte_size || 0;
                    const totalCompressed = rg.columns.reduce((sum, col) => sum + (col.total_compressed_size || 0), 0);
                    const ratio = totalUncompressed > 0 ? (totalCompressed / totalUncompressed * 100).toFixed(1) + '%' : '-';
                    
                    html += `
                        <tr>
                            <td><strong>Group ${idx + 1}</strong></td>
                            <td>${Number(rg.num_rows).toLocaleString()}</td>
                            <td>${rg.columns.length}</td>
                            <td>${formatSize(totalUncompressed)}</td>
                            <td>${formatSize(totalCompressed)}</td>
                            <td>${ratio}</td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody>';
            rowGroupTable.innerHTML = html;
        }

        function displayRawMetadata() {
            const rawMeta = document.getElementById('rawMetadata');
            const metadataDisplay = {
                version: state.metadata.version,
                created_by: state.metadata.created_by,
                num_rows: Number(state.metadata.num_rows),
                key_value_metadata: state.metadata.key_value_metadata,
                row_groups: state.metadata.row_groups?.map(rg => ({
                    num_rows: Number(rg.num_rows),
                    total_byte_size: rg.total_byte_size,
                    columns: rg.columns.length,
                    file_offset: rg.file_offset
                })),
                schema: {
                    num_fields: state.schema.children.length,
                    fields: state.schema.children.map(f => ({
                        name: f.element.name,
                        type: f.element.type,
                        converted_type: f.element.converted_type,
                        repetition_type: f.element.repetition_type
                    }))
                }
            };
            rawMeta.textContent = JSON.stringify(metadataDisplay, null, 2);
        }

        function displayData() {
            console.log('displayData called with:', {
                filteredDataLength: state.filteredData.length,
                currentPage: state.currentPage,
                pageSize: state.pageSize
            });
            
            const table = document.getElementById('dataTable');
            const start = state.currentPage * state.pageSize;
            const end = Math.min(start + state.pageSize, state.filteredData.length);
            const pageData = state.filteredData.slice(start, end);
            
            console.log('Page data:', pageData.length, 'rows');
            
            if (pageData.length === 0) {
                table.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px;">No data available</td></tr>';
                updatePagination();
                return;
            }
            
            const columns = Object.keys(pageData[0]);
            console.log('Columns:', columns);
            
            // Build header with sortable columns
            let html = '<thead><tr>';
            html += '<th class="row-number">#</th>';
            columns.forEach(col => {
                const sortClass = state.sortColumn === col ? `sorted-${state.sortDirection}` : '';
                html += `<th class="sortable ${sortClass}" onclick="sortColumn('${col}')" title="Click to sort by ${col}">${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Build rows with styled cells
            pageData.forEach((row, index) => {
                html += '<tr>';
                html += `<td class="row-number">${start + index + 1}</td>`;
                columns.forEach(col => {
                    let value = row[col];
                    let cellClass = '';
                    let displayValue = value;
                    
                    if (value === null || value === undefined) {
                        displayValue = 'null';
                        cellClass = 'cell-null';
                    } else if (typeof value === 'boolean') {
                        cellClass = 'cell-boolean';
                        displayValue = value ? 'âœ“ true' : 'âœ— false';
                    } else if (typeof value === 'number') {
                        cellClass = 'cell-number';
                        displayValue = value.toLocaleString();
                    } else if (typeof value === 'object') {
                        cellClass = 'cell-object';
                        displayValue = JSON.stringify(value);
                    } else {
                        cellClass = 'cell-string';
                        // Truncate long strings
                        if (String(value).length > 100) {
                            displayValue = String(value).substring(0, 100) + '...';
                        }
                    }
                    
                    const cellId = `cell-${start + index}-${col}`;
                    const isModified = state.modifiedCells.has(cellId);
                    const modifiedClass = isModified ? ' cell-modified' : '';
                    const editableClass = state.currentMode === 'edit' ? ' cell-editable' : '';
                    const clickHandler = state.currentMode === 'edit' ? 'onclick="editCell(this)"' : '';
                    html += `<td class="${cellClass}${editableClass}${modifiedClass}" 
                              title="${escapeHtml(String(value))}" 
                              data-row="${start + index}" 
                              data-col="${col}" 
                              data-cell-id="${cellId}"
                              ${clickHandler}>${escapeHtml(String(displayValue))}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            // Update save button visibility
            const saveParquetBtn = document.getElementById('saveParquetBtn');
            if (saveParquetBtn) {
                if (state.modifiedCells.size > 0) {
                    saveParquetBtn.style.display = 'flex';
                } else {
                    saveParquetBtn.style.display = 'none';
                }
            }
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(state.filteredData.length / state.pageSize);
            const start = state.currentPage * state.pageSize + 1;
            const end = Math.min((state.currentPage + 1) * state.pageSize, state.filteredData.length);
            
            document.getElementById('pageInfo').innerHTML = 
                `Showing <span>${start.toLocaleString()}</span> - <span>${end.toLocaleString()}</span> of <span>${state.filteredData.length.toLocaleString()}</span> rows`;
            
            document.getElementById('totalPagesText').textContent = `of ${totalPages}`;
            document.getElementById('pageJumpInput').value = state.currentPage + 1;
            document.getElementById('pageJumpInput').max = totalPages;
            
            document.getElementById('firstBtn').disabled = state.currentPage === 0;
            document.getElementById('prevBtn').disabled = state.currentPage === 0;
            document.getElementById('nextBtn').disabled = state.currentPage >= totalPages - 1;
            document.getElementById('lastBtn').disabled = state.currentPage >= totalPages - 1;
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            state.searchTerm = searchTerm;
            
            if (!searchTerm) {
                state.filteredData = [...state.data];
            } else {
                state.filteredData = state.data.filter(row => {
                    return Object.values(row).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            state.currentPage = 0;
            displayData();
        }

        function sortColumn(columnName) {
            if (state.sortColumn === columnName) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = columnName;
                state.sortDirection = 'asc';
            }
            
            state.filteredData.sort((a, b) => {
                let aVal = a[columnName];
                let bVal = b[columnName];
                
                // Handle null values
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                // Convert to comparable types
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return state.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                // String comparison
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
                
                if (state.sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            displayData();
        }

        // Event handlers
        window.showMetaTab = function(tab) {
            document.querySelectorAll('.mini-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`meta${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
        }

        window.changePage = function(direction) {
            const totalPages = Math.ceil(state.filteredData.length / state.pageSize);
            const newPage = state.currentPage + direction;
            
            if (newPage >= 0 && newPage < totalPages) {
                state.currentPage = newPage;
                displayData();
            }
        }

        window.goToPage = function(page) {
            const totalPages = Math.ceil(state.filteredData.length / state.pageSize);
            if (page >= 0 && page < totalPages) {
                state.currentPage = page;
                displayData();
            }
        }

        window.goToLastPage = function() {
            const totalPages = Math.ceil(state.filteredData.length / state.pageSize);
            state.currentPage = Math.max(0, totalPages - 1);
            displayData();
        }

        window.handlePageJump = function(event) {
            if (event.key === 'Enter') {
                const page = parseInt(event.target.value) - 1;
                goToPage(page);
            }
        }

        window.changePageSize = function() {
            const newSize = parseInt(document.getElementById('pageSizeSelect').value);
            state.pageSize = newSize;
            state.currentPage = 0;
            displayData();
        }


        window.uploadNewFile = function() {
            resetViewer();
            // Trigger file input dialog
            document.getElementById('fileInput').click();
        }

        window.downloadCurrentFile = function() {
            if (state.selectedFile) {
                const url = URL.createObjectURL(state.selectedFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = state.selectedFile.name;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Original file downloaded successfully');
            }
        }

        window.editCell = function(cell) {
            if (state.isEditing || state.currentMode !== 'edit') return; // Prevent multiple edits and only allow in edit mode
            
            const row = parseInt(cell.dataset.row);
            const col = cell.dataset.col;
            const cellId = cell.dataset.cellId;
            const originalValue = state.filteredData[row][col];
            
            state.isEditing = true;
            cell.classList.add('cell-editing');
            
            // Create input element
            const input = document.createElement('input');
            input.className = 'cell-edit-input';
            input.value = originalValue === null || originalValue === undefined ? '' : String(originalValue);
            input.type = typeof originalValue === 'number' ? 'number' : 'text';
            
            // Replace cell content
            const originalContent = cell.innerHTML;
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // Focus and select
            input.focus();
            input.select();
            
            // Handle save/cancel
            const saveEdit = () => {
                let newValue = input.value;
                
                // Convert value to appropriate type
                if (typeof originalValue === 'number') {
                    newValue = newValue === '' ? null : parseFloat(newValue);
                    if (isNaN(newValue)) newValue = originalValue; // Revert if invalid
                } else if (typeof originalValue === 'boolean') {
                    newValue = newValue.toLowerCase() === 'true';
                } else if (newValue === '' && originalValue !== '') {
                    newValue = null;
                }
                
                // Update data
                state.filteredData[row][col] = newValue;
                
                // Mark as modified if changed
                if (newValue !== originalValue) {
                    state.modifiedCells.add(cellId);
                    showToast('Cell modified - changes are local only', 'info', 2000);
                }
                
                // Restore cell display
                state.isEditing = false;
                cell.classList.remove('cell-editing');
                displayData();
            };
            
            const cancelEdit = () => {
                state.isEditing = false;
                cell.classList.remove('cell-editing');
                cell.innerHTML = originalContent;
            };
            
            // Event listeners
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        window.resetViewer = function() {
            state = {
                data: [],
                filteredData: [],
                metadata: null,
                schema: null,
                currentPage: 0,
                pageSize: 50,
                searchTerm: '',
                sortColumn: null,
                sortDirection: 'asc',
                processingStartTime: null,
                selectedFile: null,
                modifiedCells: new Set(),
                isEditing: false,
                currentMode: 'view'
            };
            
            // Show header again when returning to upload screen
            document.querySelector('header').classList.remove('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('searchInput').value = '';
        }

        window.downloadModified = async function() {
            if (state.modifiedCells.size === 0) {
                showToast('No modifications to download', 'info');
                return;
            }
            
            try {
                // Create a modified version with clear naming
                const baseName = state.selectedFile.name.replace('.parquet', '');
                const filename = `${baseName}_modified.parquet`;
                await createParquetFile(state.filteredData, filename);
            } catch (error) {
                console.error('Download failed:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }
        
        window.downloadCopy = async function() {
            try {
                // Always use current data (modified or not)
                const baseName = state.selectedFile.name.replace('.parquet', '');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `${baseName}_copy_${timestamp}.parquet`;
                
                const dataToSave = state.modifiedCells.size > 0 ? state.filteredData : state.data;
                await createParquetFile(dataToSave, filename);
            } catch (error) {
                console.error('Download failed:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }
        
        async function createParquetFile(data, filename) {
            showToast('Creating Parquet file...', 'info');
            
            try {
                // Convert our data to Apache Arrow format
                const arrowTable = createArrowTable(data);
                
                // Use parquet-wasm to write the Parquet file
                const parquetBytes = await writeParquetFile(arrowTable);
                
                // Download the file
                const blob = new Blob([parquetBytes], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast(`Successfully downloaded ${filename}`, 'success');
                
            } catch (error) {
                console.error('Error creating Parquet file:', error);
                showToast(`Failed to create Parquet file: ${error.message}`, 'error', 5000);
                throw error; // Re-throw to prevent silent failures
            }
        }
        
        let wasmInitialized = false;
        
        async function ensureWasmInitialized() {
            if (!wasmInitialized) {
                await initWasm();
                wasmInitialized = true;
            }
        }
        
        function createArrowTable(data) {
            if (!data || data.length === 0) {
                throw new Error('No data to create Arrow table');
            }
            
            // Use Apache Arrow's tableFromJSON to create a table from our data
            return tableFromJSON(data);
        }
        
        async function writeParquetFile(arrowTable) {
            try {
                // Initialize WebAssembly if not done already
                await ensureWasmInitialized();
                
                // Convert Arrow table to IPC stream format
                const ipcStream = tableToIPC(arrowTable, 'stream');
                
                // Convert to WebAssembly table
                const wasmTable = Table.fromIPCStream(ipcStream);
                
                // Create writer properties for optimal Parquet output
                const writerProperties = new WriterPropertiesBuilder()
                    .setCompression(Compression.SNAPPY)
                    .build();
                
                // Write the Arrow table to Parquet format
                const parquetBytes = writeParquet(wasmTable, writerProperties);
                
                return parquetBytes;
            } catch (error) {
                console.error('Parquet-wasm error:', error);
                throw new Error(`Parquet writing failed: ${error.message}`);
            }
        }

        window.exportData = function(format) {
            if (state.data.length === 0) return;
            
            let dataToExport, filename;
            
            switch (format) {
                case 'csv':
                    dataToExport = convertToCSV(state.data);
                    filename = `${state.selectedFile.name.replace('.parquet', '')}.csv`;
                    download(dataToExport, filename, 'text/csv');
                    break;
                    
                case 'json':
                    dataToExport = JSON.stringify(state.data, null, 2);
                    filename = `${state.selectedFile.name.replace('.parquet', '')}.json`;
                    download(dataToExport, filename, 'application/json');
                    break;
                    
                case 'filtered-csv':
                    dataToExport = convertToCSV(state.filteredData);
                    filename = `${state.selectedFile.name.replace('.parquet', '')}_filtered.csv`;
                    download(dataToExport, filename, 'text/csv');
                    break;
                    
                case 'schema':
                    const schemaData = state.schema.children.map(col => ({
                        name: col.element.name,
                        type: col.element.type,
                        converted_type: col.element.converted_type,
                        repetition_type: col.element.repetition_type
                    }));
                    dataToExport = JSON.stringify(schemaData, null, 2);
                    filename = `${state.selectedFile.name.replace('.parquet', '')}_schema.json`;
                    download(dataToExport, filename, 'application/json');
                    break;
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const columns = Object.keys(data[0]);
            let csv = columns.join(',') + '\n';
            
            data.forEach(row => {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                        return `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }

        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${filename} successfully`);
        }


        // Utility functions
        function formatSize(bytes) {
            if (typeof bytes === 'bigint') bytes = Number(bytes);
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>